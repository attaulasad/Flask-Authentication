<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <style>
    :root {
      --bg-color: #f0f2f5;
      --card-bg: #ffffff;
      --text-color: #333;
      --header-color: #2c3e50;
      --accent-color: #007bff;
      --accent-hover: #0056b3;
      --danger-color: #dc3545;
      --danger-hover: #b02a37;
      --border-color: #ddd;
      --input-bg: #fafafa;
      --note-color: #666;
      --shadow-color: rgba(0, 0, 0, 0.05);
    }

    [data-theme="dark"] {
      --bg-color: #1a1a1a;
      --card-bg: #2c2c2c;
      --text-color: #e0e0e0;
      --header-color: #ffffff;
      --accent-color: #4dabf7;
      --accent-hover: #339af0;
      --danger-color: #ff6b6b;
      --danger-hover: #fa5252;
      --border-color: #444;
      --input-bg: #333;
      --note-color: #999;
      --shadow-color: rgba(0, 0, 0, 0.3);
    }

    body {
      font-family: 'Segoe UI', Tahoma, Verdana, sans-serif;
      background-color: var(--bg-color);
      margin: 0;
      padding: 20px;
      color: var(--text-color);
      transition: all 0.3s ease;
    }

    h1 {
      text-align: center;
      color: var(--header-color);
      margin-bottom: 30px;
      font-size: 2.8rem;
    }

    .top-bar {
      position: absolute;
      top: 20px;
      left: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .theme-toggle {
      width: 40px;
      height: 40px;
      background: var(--accent-color);
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 8px var(--shadow-color);
      transition: all 0.3s ease;
      font-size: 18px;
    }

    .theme-toggle:hover {
      background: var(--accent-hover);
      transform: scale(1.1);
    }

    .theme-toggle::before {
      content: '‚òÄÔ∏è';
    }

    [data-theme="dark"] .theme-toggle::before {
      content: 'üåô';
    }

    .logout-button {
      padding: 8px 16px;
      font-size: 14px;
      background: linear-gradient(to right, var(--danger-color), var(--danger-hover));
      color: white;
      border-radius: 8px;
      text-decoration: none;
      text-align: center;
    }

    .logout-button:hover {
      background: linear-gradient(to right, var(--danger-hover), var(--danger-color));
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 24px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .api-section-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 24px;
      max-width: 1200px;
      margin: 30px auto;
    }

    section {
      background-color: var(--card-bg);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 10px 24px var(--shadow-color);
      transition: transform 0.3s ease;
      min-height: 320px;
      display: flex;
      flex-direction: column;
    }

    section:hover {
      transform: translateY(-4px);
    }

    h2 {
      font-size: 1.6rem;
      margin-bottom: 18px;
      color: var(--accent-color);
      border-left: 5px solid var(--accent-color);
      padding-left: 12px;
    }

    form {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }

    .expiry-group {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .expiry-group input,
    .expiry-group select {
      flex: 1;
    }

    form label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: var(--text-color);
    }

    input[type="text"],
    input[type="password"],
    input[type="number"],
    select {
      width: 100%;
      box-sizing: border-box;
      padding: 12px 14px;
      margin-bottom: 16px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 15px;
      background-color: var(--input-bg);
      color: var(--text-color);
      transition: border-color 0.3s ease;
    }

    input:focus, select:focus {
      border-color: var(--accent-color);
      outline: none;
    }

    button {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border-radius: 8px;
      border: none;
      background: linear-gradient(to right, var(--accent-color), var(--accent-hover));
      color: white;
      cursor: pointer;
      transition: background 0.3s ease;
      position: relative;
      margin-top: auto;
    }

    button:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }

    button:hover:not(:disabled) {
      background: linear-gradient(to right, var(--accent-hover), var(--accent-color));
    }

    .flash {
      margin: 20px auto;
      max-width: 800px;
      padding: 15px 25px;
      border-radius: 10px;
      font-weight: 500;
    }

    .flash.success {
      background-color: #e9f7ef;
      color: #2e7d32;
      border: 1px solid #c8e6c9;
    }

    .flash.danger {
      background-color: #fbe9e7;
      color: #d32f2f;
      border: 1px solid #ef5350;
    }

    .flash.info {
      background-color: #e1f5fe;
      color: #0277bd;
      border: 1px solid #4fc3f7;
    }

    .note {
      margin-bottom: 12px;
      color: var(--note-color);
      font-size: 14px;
      font-style: italic;
    }

    .api-keys-table-container {
      max-height: 400px;
      overflow-y: auto;
      margin: 16px 0;
      position: relative;
    }

    .api-keys-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .api-keys-table th,
    .api-keys-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }

    .api-keys-table th {
      background-color: var(--input-bg);
      color: var(--text-color);
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    [data-theme="dark"] .api-keys-table th {
      color: var(--accent-color);
    }

    .api-keys-table td {
      color: var(--text-color);
    }

    .api-key-hidden {
      font-family: monospace;
      color: var(--note-color);
      display: inline-block;
      max-width: 150px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
    }

    .toggle-api-key, .copy-api-key, .delete-api-key {
      background: none;
      border: none;
      color: var(--accent-color);
      cursor: pointer;
      font-size: 12px;
      padding: 6px 12px;
      border-radius: 4px;
      transition: background 0.2s ease;
    }

    .toggle-api-key:hover, .copy-api-key:hover, .delete-api-key:hover {
      background: rgba(0, 123, 255, 0.1);
    }

    .delete-api-key {
      color: var(--danger-color);
    }

    .delete-api-key:hover {
      background: rgba(220, 53, 69, 0.1);
      color: var(--danger-hover);
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background-color: var(--card-bg);
      padding: 24px;
      border-radius: 8px;
      max-width: 400px;
      width: 90%;
      text-align: center;
      position: relative;
      box-shadow: 0 4px 16px var(--shadow-color);
    }

    .modal-content p {
      margin: 15px 0;
      font-family: monospace;
      word-break: break-all;
      color: var(--text-color);
      font-size: 14px;
    }

    .close-modal {
      position: absolute;
      top: 12px;
      right: 16px;
      background: none;
      border: none;
      font-size: 14px;
      cursor: pointer;
      color: var(--text-color);
      padding: 4px;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }

    .close-modal:hover {
      background-color: transparent;
      color: var(--accent-color);
    }

    .search-container {
      margin-bottom: 16px;
    }

    .search-container input {
      width: 100%;
      padding: 10px;
      font-size: 14px;
    }

    @media (max-width: 600px) {
      section {
        padding: 18px;
        min-height: 280px;
      }

      h1 {
        font-size: 2rem;
      }

      h2 {
        font-size: 1.4rem;
      }

      .api-section-grid {
        grid-template-columns: 1fr;
      }

      .api-keys-table {
        font-size: 12px;
      }

      .api-keys-table th, .api-keys-table td {
        padding: 8px;
      }

      .api-key-hidden {
        max-width: 100px;
      }

      .action-buttons {
        flex-wrap: wrap;
      }
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <a href="{{ url_for('logout') }}" class="logout-button" aria-label="Log out">Logout</a>
    <button class="theme-toggle" aria-label="Toggle theme" onclick="toggleTheme()"></button>
  </div>
  <h1>Admin Dashboard</h1>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="flash {{ category }}" role="alert">{{ message | safe }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <div class="dashboard-grid">
    <section aria-labelledby="create-user">
      <h2 id="create-user">Create User</h2>
      <form method="POST" action="{{ url_for('create_user_form') }}" onsubmit="handleFormSubmit(this)">
        <label for="username">Email</label>
        <input type="text" name="username" id="username" placeholder="Enter email" required aria-required="true">

        <label for="password">Password</label>
        <input type="password" name="password" id="password" placeholder="Enter password" required aria-required="true">

        <label for="credits">Credits</label>
        <input type="number" name="credits" id="credits" value="10" min="1" required aria-required="true">

        <label for="expiry_value">Expiry</label>
        <div class="expiry-group">
          <input type="number" name="expiry_value" id="expiry_value" value="365" min="1" placeholder="Enter expiry value" required aria-required="true">
          <select name="expiry_unit" id="expiry_unit">
            <option value="Minutes">Minutes</option>
            <option value="Days" selected>Days</option>
            <option value="Months">Months</option>
          </select>
        </div>

        <button type="submit">Create User</button>
      </form>
    </section>

    <section aria-labelledby="generate-api-key">
      <h2 id="generate-api-key">Generate API Key</h2>
      <p class="note"><strong>Note:</strong> Users can have only one API key at a time.</p>
      <form method="POST" action="{{ url_for('generate_api_key_form') }}" onsubmit="handleFormSubmit(this)">
        <label for="account_id_generate">Select User</label>
        <select name="account_id" id="account_id_generate" required aria-required="true">
          <option value="" disabled selected>Select a user</option>
          {% if users %}
            {% for user in users %}
              <option value="{{ user.id }}">{{ user.username }}</option>
            {% endfor %}
          {% else %}
            <option value="" disabled>No users found</option>
          {% endif %}
        </select>

        <button type="submit">Generate API Key</button>
      </form>
    </section>

    <section aria-labelledby="refill-credits">
      <h2 id="refill-credits">Refill Credits</h2>
      <form method="POST" action="{{ url_for('refill_credits_form') }}" onsubmit="handleFormSubmit(this)">
        <label for="account_id_credits">Select User</label>
        <select name="account_id" id="account_id_credits" required aria-required="true">
          <option value="" disabled selected>Select a user</option>
          {% if users %}
            {% for user in users %}
              <option value="{{ user.id }}">{{ user.username }}</option>
            {% endfor %}
          {% else %}
            <option value="" disabled>No users found</option>
          {% endif %}
        </select>

        <label for="add_credits">Add Credits</label>
        <input type="number" name="add_credits" id="add_credits" value="10" min="1" required aria-required="true">

        <button type="submit">Refill Credits</button>
      </form>
    </section>

    <section aria-labelledby="extend-time">
      <h2 id="extend-time">Extend Time</h2>
      <form method="POST" action="{{ url_for('extend_time_form') }}" onsubmit="handleFormSubmit(this)">
        <label for="account_id_time">Select User</label>
        <select name="account_id" id="account_id_time" required aria-required="true">
          <option value="" disabled selected>Select a user</option>
          {% if users %}
            {% for user in users %}
              <option value="{{ user.id }}">{{ user.username }}</option>
            {% endfor %}
          {% else %}
            <option value="" disabled>No users found</option>
          {% endif %}
        </select>

        <label for="add_minutes">Add Time</label>
        <div class="expiry-group">
          <input type="number" name="add_minutes" id="add_minutes" value="30" min="1" required aria-required="true">
          <select name="add_unit" id="add_unit">
            <option value="Minutes">Minutes</option>
            <option value="Days" selected>Days</option>
            <option value="Months">Months</option>
          </select>
        </div>

        <button type="submit">Extend Time</button>
      </form>
    </section>

    <section aria-labelledby="check-status">
      <h2 id="check-status">Check User Status</h2>
      <form method="POST" action="{{ url_for('check_user_status_form') }}" onsubmit="handleFormSubmit(this)">
        <label for="account_id_status">Select User</label>
        <select name="account_id" id="account_id_status" required aria-required="true">
          <option value="" disabled selected>Select a user</option>
          {% if users %}
            {% for user in users %}
              <option value="{{ user.id }}">{{ user.username }}</option>
            {% endfor %}
          {% else %}
            <option value="" disabled>No users found</option>
          {% endif %}
        </select>
        <button type="submit">Check Status</button>
      </form>
    </section>

    <section aria-labelledby="delete-user">
      <h2 id="delete-user">Delete User</h2>
      <form id="delete-user-form" method="POST" action="{{ url_for('delete_user_form') }}" onsubmit="return handleDeleteForm(event)">
        <label for="account_id_delete">Select User</label>
        <select name="account_id" id="account_id_delete" required aria-required="true">
          <option value="" disabled selected>Choose an option...</option>
          <option value="delete_all">Delete All Users</option>
          {% if users %}
            {% for user in users %}
              <option value="{{ user.id }}">{{ user.username }}</option>
            {% endfor %}
          {% else %}
            <option value="" disabled>No users found</option>
          {% endif %}
        </select>
        <button type="submit">Delete User</button>
      </form>
    </section>
  </div>

  <div class="api-section-grid">
    <section aria-labelledby="active-api-keys">
      <h2 id="active-api-keys">Active API Keys</h2>
      <div class="search-container">
        <input type="text" id="api-key-search" placeholder="Search API keys by username..." oninput="filterApiKeys()">
      </div>
      <div class="api-keys-table-container">
        {% if active_api_keys %}
          <table class="api-keys-table" aria-describedby="active-api-keys">
            <thead>
              <tr>
                <th scope="col">User</th>
                <th scope="col">Key</th>
                <th scope="col">Credits</th>
                <th scope="col">Token</th>
                <th scope="col">Expiry</th>
                <th scope="col">Actions</th>
              </tr>
            </thead>
            <tbody id="api-keys-tbody">
              {% for key in active_api_keys %}
                <tr class="api-key-row">
                  <td>{{ key.username }}</td>
                  <td>
                    <span class="api-key-hidden" id="api-key-{{ key.api_key_id }}" data-api-key="{{ key.api_key }}">{{ key.api_key[:8] }}...</span>
                  </td>
                  <td>{{ key.credits }}</td>
                  <td>{{ key.token[:8] }}...</td>
                  <td>{{ key.expiry }}</td>
                  <td class="action-buttons">
                    <button class="toggle-api-key" onclick="showApiKey('api-key-{{ key.api_key_id }}')" aria-label="Show API key for {{ key.username }}">Show</button>
                    <button class="copy-api-key" onclick="copyApiKey('api-key-{{ key.api_key_id }}')" aria-label="Copy API key for {{ key.username }}">Copy</button>
                    <button class="delete-api-key" onclick="deleteApiKey('{{ key.api_key_id }}')" aria-label="Delete API key for {{ key.username }}">Delete</button>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p>No active API keys found.</p>
        {% endif %}
      </div>
    </section>
  </div>

  <div id="api-key-modal" class="modal" role="dialog" aria-labelledby="modal-title">
    <div class="modal-content">
      <button class="close-modal" onclick="closeModal()" aria-label="Close modal">‚úï</button>
      <h3 id="modal-title">API Key</h3>
      <p id="modal-api-key"></p>
    </div>
  </div>

  <script>
    function toggleTheme() {
      console.log('Toggling theme');
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      console.log('Theme set to:', newTheme);
    }

    function showApiKey(id) {
      console.log('Showing API key for ID:', id);
      const apiKeyElement = document.getElementById(id);
      const modal = document.getElementById('api-key-modal');
      const modalKey = document.getElementById('modal-api-key');
      modalKey.textContent = apiKeyElement.dataset.apiKey;
      modal.style.display = 'flex';
    }

    function closeModal() {
      console.log('Closing modal');
      const modal = document.getElementById('api-key-modal');
      modal.style.display = 'none';
    }

    function copyApiKey(id) {
      console.log('Copying API key for ID:', id);
      const apiKeyElement = document.getElementById(id);
      const apiKey = apiKeyElement.dataset.apiKey;
      navigator.clipboard.writeText(apiKey).then(() => {
        alert('API key copied to clipboard!');
        console.log('API key copied successfully');
      }).catch(err => {
        console.error('Failed to copy API key:', err);
        alert('Failed to copy API key: ' + err.message);
      });
    }

    function deleteApiKey(apiKeyId) {
      console.log('Attempting to delete API key ID:', apiKeyId);
      if (confirm('Are you sure you want to delete this API key?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("delete_api_key_form") }}';
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'api_key_id';
        input.value = apiKeyId;
        form.appendChild(input);
        document.body.appendChild(form);
        console.log('Submitting delete API key form');
        form.submit();
      } else {
        console.log('API key deletion cancelled');
      }
    }

    function filterApiKeys() {
      const searchInput = document.getElementById('api-key-search').value.toLowerCase();
      const rows = document.querySelectorAll('.api-key-row');
      rows.forEach(row => {
        const username = row.cells[0].textContent.toLowerCase();
        row.style.display = username.includes(searchInput) ? '' : 'none';
      });
    }

    function handleDeleteForm(event) {
      event.preventDefault();
      const form = event.target;
      const accountId = form.querySelector('select[name="account_id"]').value;
      console.log('Delete user form submitted with account_id:', accountId);
      if (!accountId) {
        alert('Please select an option to delete.');
        console.log('No account_id selected');
        return false;
      }
      const confirmMessage = accountId === 'delete_all'
        ? 'Are you sure you want to delete ALL users and their associated data? This action cannot be undone.'
        : 'Are you sure you want to delete this user?';
      if (confirm(confirmMessage)) {
        console.log('User confirmed deletion for account_id:', accountId);
        form.submit();
        return true;
      } else {
        console.log('User deletion cancelled');
        return false;
      }
    }

    function handleFormSubmit(form) {
      console.log('Submitting form:', form.action);
      const button = form.querySelector('button[type="submit"]');
      button.disabled = true;
      button.textContent = 'Processing...';
      form.addEventListener('submit', () => {
        setTimeout(() => {
          button.disabled = false;
          button.textContent = button.dataset.originalText || 'Submit';
        }, 5000);
      }, { once: true });
    }

    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM loaded');
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      console.log('Initial theme:', savedTheme);

      const modal = document.getElementById('api-key-modal');
      modal.addEventListener('click', function(event) {
        if (event.target === modal) {
          closeModal();
        }
      });

      document.querySelectorAll('button[type="submit"]').forEach(button => {
        button.dataset.originalText = button.textContent;
      });

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && modal.style.display === 'flex') {
          closeModal();
        }
      });
    });
  </script>
</body>
</html>